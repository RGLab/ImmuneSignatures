---
title: "HIPC ImmuneSignatures Project Meta Analysis Using Data from ImmuneSpace"
authors: "HIPC ImmuneSignatures Project Collaborators"
package developer: "Evan Henrich, Gottardo Lab @ Fred Hutchinson Cancer Research Center"
contact: "ehenrich@fredhutch.org"
date: "`r Sys.Date()`"
output: rmarkdown::html_document
---

***
## PACKAGE INFORMATION
#### Created: January 2017
#### Study Authors: HIPC ImmuneSignature Collaborators
#### Package Developer: Evan Henrich (Gottardo Lab - FHCRC)
#### Contact: ehenrich@fredhutch.org

***

## GENERAL NOTES:
This markdown file outputs the results of the HIPC ImmuneSignatures Project using the original parameters and
streamlined code from the published manuscript but run with data coming directly from ImmuneSpace. In order 
to save time, the gene expression matrices are pre-loaded as data within the package.  The code to generate 
these expression matrices from ImmuneSpace / GEO can be found in the "get_GE.R" script within the package.
There are two cases where data from ImmuneSpace could not be used: SDY80 (hai) and SDY400 (ge).  

The SDY80 hai data available on ImmuneSpace is not incorporated into the analysis because it does not include 
subjects without gene expression data.  Although subjects without GE data are filtered out later, they must 
be included in the adjust_hai.R script in order to achieve the same results for the "endPoint" variable 
("fc_res_maxd30").  The original raw HAI data came from Yuri Kotliarov at NIH and is included within the package. 

The SDY400 gene expression data used in the package comes from the authors at Yale University because the "series.txt"
file on GEO has different probe-to-gene symbol mapping that cannot be retroactively changed, while the
"non-normalized.txt" version on GEO has experiment specific subject ID mappings that were not able to be correctly
given ImmuneSpace subject ids at the time of this report's development.

Finally, the results for the "old" cohort using SDY67 data are slightly different (<0.5% Relative Error).  This is 
believed to be due rounding to the 6th decimal that occurs during preprocessing.

```{r set-options, include=FALSE}
library(ImmSig2) # to load data and helper functions
library(Rlabkey)
library(Biobase) 
library(stringr)
library(hash)
library(dplyr)
library(qusage)
library(RCurl)
library(data.table)
library(preprocessCore)

options(width = 999)
knitr::opts_chunk$set(echo=FALSE, 
               #cache.path=paste(labkey.file.root, "cache/pubmed_report_cache/", sep="/"), # for IS site only
               cache=TRUE, 
               warning=FALSE, 
               message=FALSE, 
               tidy=TRUE,
               fig.height=7, 
               fig.width=7,
               fig.align = "center")
```

```{r prepare-esets, include=FALSE}
# 1. Create expressionSet object using data from ImmuneSpace
studies <- c("SDY212","SDY63","SDY404","SDY400","SDY67","SDY80")
eset_list <- list()

for(sdy in studies){
  if(sdy %in% c("SDY400")){
    # SDY400:
    # Using original table because GEO series matrix produces different results in terms of gene symbols
    # incorporated into qusage analysis, perhaps due to different normalization method(?), and GEO
    # non-normalized.txt does not have sample names that can be mapped with available information.
    # All original tables come from HIPC Google Drive.
    em <- get(paste0(tolower(sdy), "_exprMxOrig"))
  } else {
    # See comments in get_GE.R for methodology of generating expression matrices. These matrices
    # are created using online, public sources (e.g. GEO or ImmuneSpace).
    em <- getGE(sdy) 
  }
  if(sdy == "SDY212"){ em <- em[ , -(grep("SUB134307.*", colnames(em))) ] } # Remove dup biosamples
  new_fData <- data.frame(gene_symbol = em$geneSymbol, stringsAsFactors = F)
  rownames(new_fData) <- rownames(em)
  eset <- ExpressionSet(assayData = as.matrix(em),
                        featureData = AnnotatedDataFrame(new_fData))

  # Parse Subject IDs and Limit expression data to baseline (d0) only
  factored_ids <- str_match(sampleNames(eset), "(((SUB)|(sub))_?[0-9]+)(\\.[0-9])?_(.*)")
  eset$Condition <- factor(factored_ids[, 7L])
  eset <- eset[ , grep("^d0", eset$Condition) ]

  # Get baseline eset Subjects
  factored_ids <- str_match(sampleNames(eset), "(((SUB)|(sub))_?[0-9]+)(\\.[0-9])?_(.*)")
  eset_subs <- factored_ids[, 2L]

  # Get raw HAI data from Immunespace where feasible and adjust according to Yuri Kotliarov code.
  # NOTE: SDY80 raw data in ImmuneSpace differs, therefore using preloaded.
  # labkey.url.path <- paste0("/Studies/", sdy, "/") # for IS site only
  con <- CreateConnection(sdy)
  raw_hai <- if(sdy != "SDY80"){ con$getDataset("hai") }else{ SDY80_rawtiterdata_v2 }
  adj_hai <- adjust_hai(sdy, raw_hai)

  # Age needed for SDY80 to remove subjects over 36 years old
  if(sdy == "SDY80"){
    demo <- con$getDataset("demographics")
    adj_hai$Age <- sapply(adj_hai$subject, FUN = function(x){
      trg <- demo[ which(demo$participant_id == paste0(x, ".80"))]
      return(trg$age_reported)
    })
    adj_hai <- adj_hai[ which(adj_hai$Age < 36), ]
  }

  # Ensure HAI and eset contain same subjects in same order, then push to pData
  eset <- eset[ , which(eset_subs %in% adj_hai$subject) ]
  adj_hai <- adj_hai[ which(adj_hai$subject %in% eset_subs), ]
  adj_hai <- adj_hai[ order(match(adj_hai$subject, eset_subs)), ]
  rownames(adj_hai) <- sampleNames(eset)
  pData(eset) <- droplevels(adj_hai)
  
  # push to holder
  eset_list[[sdy]] <- eset
}

# Prep GeneSetDB
gene_set <- strsplit(geneSetDB, "\t")            ## convert from vector of strings to a list
names(gene_set) <- sapply(gene_set,"[", 1)       ## move the names column as the names of the list
links <- sapply(gene_set,"[", 2)
gene_set <- lapply(gene_set, "[",-1:-2)         ## remove name and description columns
gene_set <- lapply(gene_set, function(x){ x[ which( x != "") ] })      ## remove empty strings
  
```

## META-ANALYSIS 

### YOUNG COHORT RESULTS
```{r meta-analysis-young, include=TRUE, results="markup"}
yng_res <- meta_analysis(eset_list = eset_list,
                         cohort = "young",
                         gene_set = gene_set)
```

#### Discovery Group Significant Pathways Data  
``` {r include=TRUE}
DT::datatable(yng_res$dsc)
```

#### Validation Study Significant Pathways Data  
``` {r include=TRUE}
DT::datatable(yng_res$val)
```

***

### OLD COHORT RESULTS

```{r meta-analysis-old, include=TRUE, results="markup"}
old_res <- meta_analysis(eset_list = eset_list,
                         cohort = "old",
                         gene_set = gene_set)
```

#### Discovery Group Significant Pathways Data  
``` {r}
DT::datatable(old_res$dsc)
```

#### Validation Study Significant Pathways Data  
``` {r}
DT::datatable(old_res$val)
```

***

### PARAMETERS:
- **FDR.cutoff: ** 0.5
- **pvalue.cutoff: ** 0.01
- **endPoint: ** fc_res_max_d30
- **geneSetDB: ** BTM_for_GSEA_20131008.gmt
